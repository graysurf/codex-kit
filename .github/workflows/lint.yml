name: Lint

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  shell-and-contracts:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      CODEX_HOME: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install zsh (for zsh -n)
        run: |
          if ! command -v zsh >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y zsh
          fi

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Shell lint + syntax (bash + zsh)
        run: |
          $CODEX_HOME/scripts/lint.sh --shell

      - name: Env bool audit
        run: |
          zsh -f $CODEX_HOME/scripts/audit-env-bools.zsh --check

      - name: Validate skill contract sections
        run: |
          $CODEX_HOME/skills/tools/skill-management/skill-governance/scripts/validate_skill_contracts.sh

      - name: Validate skill directory layout
        run: |
          $CODEX_HOME/skills/tools/skill-management/skill-governance/scripts/audit-skill-layout.sh

      - name: Smoke test (negative fixture)
        run: |
          set -euo pipefail

          tmp="$(mktemp)"
          cat >"$tmp" <<'MD'
          # Fixture Skill

          ## Contract

          Prereqs:
          - N/A

          Inputs:
          - N/A

          Outputs:
          - N/A

          Exit codes:
          - N/A
          MD

          if $CODEX_HOME/skills/tools/skill-management/skill-governance/scripts/validate_skill_contracts.sh --file "$tmp"; then
            echo "Expected validate_skill_contracts.sh to fail for missing 'Failure modes:'." >&2
            exit 1
          fi

  pytest:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      CODEX_HOME: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install zsh (for script shebangs)
        run: |
          if ! command -v zsh >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y zsh
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements-dev.txt

      - name: Install image processing deps (ImageMagick + WebP + JPEG tools)
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick webp libjpeg-progs

      - name: Install pytest deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-dev.txt

      - name: Python lint + typecheck (ruff + mypy + pyright)
        run: |
          $CODEX_HOME/scripts/lint.sh --python

      - name: Pytest
        run: |
          $CODEX_HOME/scripts/test.sh

      - name: Script coverage summary
        if: always()
        run: |
          set -euo pipefail

          if [[ -z "${GITHUB_STEP_SUMMARY:-}" ]]; then
            exit 0
          fi

          if [[ -f out/tests/script-coverage/summary.md ]]; then
            cat out/tests/script-coverage/summary.md >>"$GITHUB_STEP_SUMMARY"
          else
            echo "## Script coverage (functional)" >>"$GITHUB_STEP_SUMMARY"
            echo "" >>"$GITHUB_STEP_SUMMARY"
            echo "_No script coverage report found at out/tests/script-coverage/summary.md._" >>"$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload script regression artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-artifacts
          if-no-files-found: warn
          path: |
            out/tests/script-regression/summary.json
            out/tests/script-regression/logs
            out/tests/script-smoke/summary.json
            out/tests/script-smoke/logs
            out/tests/script-coverage/summary.json
            out/tests/script-coverage/summary.md
            out/tests/script-smoke/api-test-summary
