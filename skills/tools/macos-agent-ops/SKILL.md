---
name: macos-agent-ops
description: Use Homebrew-installed macos-agent to run repeatable app automation checks and routine tasks on macOS.
---

# macos-agent ops

## Contract

Prereqs:

- macOS host with Accessibility and Automation permissions granted for Terminal and target apps.
- Homebrew-installed `macos-agent` available on `PATH`.
- `cliclick` and `osascript` available on `PATH`.

Inputs:

- Command entrypoint: `$CODEX_HOME/skills/tools/macos-agent-ops/scripts/macos-agent-ops.sh`.
- Optional env vars:
  - `MACOS_AGENT_REAL_E2E_INPUT_SOURCE` (example: `abc`) for deterministic input source.
  - `MACOS_AGENT_OPS_SKIP_INPUT_SOURCE_SWITCH=1` to bypass automatic switch to US/ABC.

Outputs:

- macos-agent JSON/text command output.
- Artifacts generated by macos-agent under `$CODEX_HOME/out/` (screenshots, traces, step ledgers).

Exit codes:

- `0`: success
- `1`: runtime failure or missing runtime dependency
- `2`: usage error

Failure modes:

- `wait app-active` timeouts because focus was stolen (Control Center/Spotlight/notifications).
- `window.activate` timeout when app update/relauncher is stuck (commonly Spotify).
- `not authorized` / Apple Events denial from TCC permissions.
- typed text mismatch when non-English input method is active.

## Scripts (only entrypoints)

- `$CODEX_HOME/skills/tools/macos-agent-ops/scripts/macos-agent-ops.sh`

## Workflow

1. Auto-switch input source to US/ABC (`ABC`) before running `doctor` / `app-check` / `scenario` / `run`.
   - This is built into the script to avoid IME-induced typing failures.
   - If you intentionally need another input method, set `MACOS_AGENT_OPS_SKIP_INPUT_SOURCE_SWITCH=1`.

2. Resolve Homebrew macos-agent binary path:

```bash
$CODEX_HOME/skills/tools/macos-agent-ops/scripts/macos-agent-ops.sh where
```

3. Run environment readiness checks:

```bash
$CODEX_HOME/skills/tools/macos-agent-ops/scripts/macos-agent-ops.sh doctor
```

4. Run quick app-foreground check (for scheduled sanity jobs):

```bash
$CODEX_HOME/skills/tools/macos-agent-ops/scripts/macos-agent-ops.sh app-check --app Finder
$CODEX_HOME/skills/tools/macos-agent-ops/scripts/macos-agent-ops.sh app-check --app Arc --timeout-ms 12000
```

5. Run routine scripted actions:

```bash
$CODEX_HOME/skills/tools/macos-agent-ops/scripts/macos-agent-ops.sh scenario --file /path/to/scenario.json
```

6. Pass through any raw macos-agent command:

```bash
$CODEX_HOME/skills/tools/macos-agent-ops/scripts/macos-agent-ops.sh run -- --format json windows list --app Finder
```

## Screenshot-Based Triage Rules

- During runtime failure triage, the agent SHOULD capture an active-window screenshot before any retry or remediation.
- For `wait app-active` and `window.activate` timeout failures, screenshot capture SHOULD be treated as a first-line diagnostic step.
- Screenshot artifacts MUST be written under `$CODEX_HOME/out/` and SHOULD use timestamped filenames for traceability.
- The agent SHOULD include the screenshot path in the final diagnostic summary, together with the failing command and error message.

Recommended command (via the skill entrypoint):

```bash
$CODEX_HOME/skills/tools/macos-agent-ops/scripts/macos-agent-ops.sh run -- \
  --format json observe screenshot --active-window \
  --path "$CODEX_HOME/out/macos-agent-failure-$(date +%Y%m%d-%H%M%S).png"
```

## Common Errors And Prevention

- `error: timed out waiting for app-active ...`
  - Keep hands off keyboard/mouse while running.
  - Close Control Center/Spotlight overlays and disable noisy notifications.
  - Increase timeout (`--timeout-ms 12000` or higher) for slow app transitions.

- `error: window.activate via osascript timed out ...` (especially Spotify)
  - Kill stale updater/relauncher processes and relaunch the app once before rerunning:
    - `pkill -f '/sp_relauncher upgrade ' || true`
    - `pkill -x Spotify || true`
    - `open -a Spotify`

- `not authorized` / Apple Events failures
  - Re-run `doctor` and fix Accessibility/Automation in System Settings.

- text input mismatch or wrong characters
  - The skill script now auto-switches to US/ABC before operational commands.
  - Keep `ABC` enabled in macOS Input Sources.
  - If you must keep another IME, set `MACOS_AGENT_OPS_SKIP_INPUT_SOURCE_SWITCH=1`.
  - Prefer clipboard-paste style flows over character-by-character typing.

- Homebrew macos-agent missing
  - Install and link with Homebrew: `brew install macos-agent`.

## References

- `skills/tools/macos-agent-ops/references/e2e-ref-01-preflight-focus.md`
- `skills/tools/macos-agent-ops/references/e2e-ref-02-finder-routine.md`
- `skills/tools/macos-agent-ops/references/e2e-ref-03-matrix-routine.md`
