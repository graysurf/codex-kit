# Plan-Issue-Delivery E2E Runbook (Sprint 1 + Sprint 2)

## Prerequisites

- `plan-tooling` and `plan-issue` are available on `PATH`.
- A plan issue already exists and dispatch artifacts were generated by `start-sprint`.
- Main-agent is orchestration-only; subagents own implementation PRs and lane execution.
- Runtime paths are exported in the current shell (for example `PLAN_SNAPSHOT_PATH` and task-scoped `DISPATCH_RECORD_PATH`).

## Command Timeline

1. Validate the source plan:
   `plan-tooling validate --file docs/plans/plan-issue-delivery-e2e-test-plan.md`
2. Start sprint dispatch flow:
   `plan-issue start-sprint --plan docs/plans/plan-issue-delivery-e2e-test-plan.md --issue <issue-number> --sprint <n> --pr-grouping group --strategy auto`
3. Verify dispatch bundle artifacts before implementation handoff:
   `test -f "$PLAN_SNAPSHOT_PATH" && test -f "$TASK_PROMPT_PATH" && test -f "$SUBAGENT_INIT_SNAPSHOT_PATH" && test -f "$DISPATCH_RECORD_PATH"`
4. Subagents implement assigned tasks and open or update lane PRs linked from runtime-truth rows.
5. Main-agent runs `ready-sprint`, reviews merge evidence, then proceeds to `accept-sprint` with approval evidence.

## Runtime Artifact Checklist

| Artifact Path | Verification Method | Expected State |
| --- | --- | --- |
| `PLAN_SNAPSHOT_PATH` | `test -f "$PLAN_SNAPSHOT_PATH"` | Present under issue runtime `plan/` and readable before dispatch. |
| `TASK_PROMPT_PATH` | `test -f "$TASK_PROMPT_PATH"` | Present under sprint `prompts/` and mapped to assigned task ID. |
| `SUBAGENT_INIT_SNAPSHOT_PATH` | `test -f "$SUBAGENT_INIT_SNAPSHOT_PATH"` | Present under sprint `prompts/` and immutable for sprint execution. |
| `DISPATCH_RECORD_PATH` | `test -f "$DISPATCH_RECORD_PATH"` | Present under sprint `manifests/` for each assigned task. |

## Sprint 1 Gate Checks

- Pre-dispatch gate: required artifacts exist and align with assigned task IDs, worktree, and branch.
- Scope gate: main-agent remains orchestration-only and does not implement sprint code changes directly.
- Lane gate: each lane PR is linked with canonical `#<number>` format in `## Task Decomposition`.
- Sprint gate: `accept-sprint` only runs after required lane PRs are merged and approval evidence is available.

## Sprint 2 Gating Checklist

- [ ] Task-scoped PR link command was used for lane rows:
  `plan-issue link-pr --plan docs/plans/plan-issue-delivery-e2e-test-plan.md --issue <issue-number> --sprint 2 --task <task-id> --pr <pr-number-or-url>`
- [ ] Sprint-scoped lane sync command was used when grouped lanes need normalization:
  `plan-issue link-pr --plan docs/plans/plan-issue-delivery-e2e-test-plan.md --issue <issue-number> --sprint 2 --pr-group s2-auto-g1 --pr <pr-number-or-url>`
  (Use `link-pr --task` for a single task row and `link-pr --sprint` for group/lane-wide synchronization.)
- [ ] Review handoff command has been run and recorded:
  `plan-issue ready-sprint --plan docs/plans/plan-issue-delivery-e2e-test-plan.md --issue <issue-number> --sprint 2 --pr-grouping group --strategy auto`
- [ ] `accept-sprint` precondition: every linked sprint PR is merged before acceptance.
- [ ] Sprint approval evidence is available as an `approved-comment-url` before acceptance.
- [ ] Acceptance command includes required approval evidence:
  `plan-issue accept-sprint --plan docs/plans/plan-issue-delivery-e2e-test-plan.md --issue <issue-number> --sprint 2 --pr-grouping group --strategy auto --approved-comment-url <comment-url>`
