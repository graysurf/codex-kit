# Plan-Issue-Delivery E2E Runbook (Sprint 1 + Sprint 2 + Sprint 3)

Sprint anchors: `Prerequisites/Command Timeline/Gate Checks/orchestration-only/ready-plan/close-plan`.

## Prerequisites

- `plan-tooling` and `plan-issue` are available on `PATH`.
- A plan issue already exists and dispatch artifacts were generated by `start-sprint`.
- Main-agent is orchestration-only; subagents own implementation PRs and lane execution.
- Runtime paths are exported in the current shell (for example `PLAN_SNAPSHOT_PATH` and task-scoped `DISPATCH_RECORD_PATH`).

## Command Timeline

1. Validate the source plan: `plan-tooling validate --file docs/plans/plan-issue-delivery-e2e-test-plan.md`
2. Start sprint dispatch flow:

   ```bash
   plan-issue start-sprint --plan docs/plans/plan-issue-delivery-e2e-test-plan.md --issue <issue-number> --sprint <n> --strategy auto --default-pr-grouping group
   ```

3. Verify dispatch bundle artifacts before implementation handoff:

   ```bash
   test -f "$PLAN_SNAPSHOT_PATH" && test -f "$TASK_PROMPT_PATH" && test -f "$SUBAGENT_INIT_SNAPSHOT_PATH" && test -f "$DISPATCH_RECORD_PATH"
   ```

4. Subagents implement assigned tasks and open/update lane PRs linked from runtime-truth rows.
5. Main-agent runs `ready-sprint`, reviews merge evidence, then proceeds to `accept-sprint` with approved comment URL.

## Runtime Artifact Checklist

| Artifact Path                 | Verification Method                      | Expected State                                                      |
| ----------------------------- | ---------------------------------------- | ------------------------------------------------------------------- |
| `PLAN_SNAPSHOT_PATH`          | `test -f "$PLAN_SNAPSHOT_PATH"`          | Present under issue runtime `plan/` and readable before dispatch.   |
| `TASK_PROMPT_PATH`            | `test -f "$TASK_PROMPT_PATH"`            | Present under sprint `prompts/` and mapped to assigned task ID.     |
| `SUBAGENT_INIT_SNAPSHOT_PATH` | `test -f "$SUBAGENT_INIT_SNAPSHOT_PATH"` | Present under sprint `prompts/` and immutable for sprint execution. |
| `DISPATCH_RECORD_PATH`        | `test -f "$DISPATCH_RECORD_PATH"`        | Present under sprint `manifests/` for each assigned task.           |

## Sprint 1 Gate Checks

- Pre-dispatch gate: required artifacts exist and align with assigned task IDs, worktree, and branch.
- Scope gate: main-agent remains orchestration-only and does not implement sprint code changes directly.
- Lane gate: each lane PR is linked with canonical `#<number>` format in `## Task Decomposition`.
- Sprint gate: `accept-sprint` only runs after required lane PRs are merged and approval evidence is available.

## Sprint 2 Gating Checklist

- [ ] Task-scoped PR link command was used for lane rows:

  ```bash
  plan-issue link-pr --task <task-id> --sprint 2 --plan docs/plans/plan-issue-delivery-e2e-test-plan.md --issue <issue-number> --pr <pr-number-or-url>
  ```

- [ ] Sprint-scoped lane sync command was used when grouped lanes need normalization:

  ```bash
  plan-issue link-pr --sprint 2 --plan docs/plans/plan-issue-delivery-e2e-test-plan.md --issue <issue-number> --pr-group s2-auto-g1 --pr <pr-number-or-url>
  ```

  (Use `link-pr --task` for a single task row and `link-pr --sprint` plus `--pr-group` for lane-wide normalization.)
- [ ] Review handoff command has been run and recorded:

  ```bash
  plan-issue ready-sprint --plan docs/plans/plan-issue-delivery-e2e-test-plan.md --issue <issue-number> --sprint 2 --strategy auto --default-pr-grouping group
  ```

- [ ] `accept-sprint` precondition: every linked sprint PR is merged before acceptance.
- [ ] Sprint approval evidence is available as an `approved-comment-url` before acceptance.
- [ ] Acceptance command includes required approval evidence:

  ```bash
  plan-issue accept-sprint --plan docs/plans/plan-issue-delivery-e2e-test-plan.md --issue <issue-number> --sprint 2 --strategy auto --default-pr-grouping group --approved-comment-url <comment-url>
  ```

## Sprint 3 Final Plan Review and Close Checklist

Use this final-gate section only after all sprint-level `accept-sprint` loops are complete.

- [ ] Final plan review command has been run and recorded:

  ```bash
  plan-issue ready-plan --issue <issue-number>
  ```

- [ ] `ready-plan` evidence confirms every required sprint PR is merged and no required task row is pending.
- [ ] Final closure command is prepared with plan-level approval evidence:

  ```bash
  plan-issue close-plan --issue <issue-number> --approved-comment-url <comment-url>
  ```

- [ ] `close-plan` is blocked when the merged-PR gate fails for any required lane PR.
- [ ] `close-plan` is blocked when plan-level approval evidence is missing or invalid.
